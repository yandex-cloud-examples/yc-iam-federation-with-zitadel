
# Terraform модуль `usersgen` 

## Оглавление
* [Описание модуля](#ug-overview)
* [Входные параметры модуля](#ug-inputs)
  * [Шаблоны пользовательских ресурсов](#user-template)
* [Выходные параметры модуля](#ug-outputs)
* [Управление пользователями](#ug-operations)


## Описание модуля <a id="ug-overview"/></a>

Модуль [usersgen](../usersgen/) является вспомогательным для модуля [zitadel-config](../zitadel-config/README.md) из которого вызывается.

С помощью данного модуля осуществляется управление обычными пользователями *(не менеджерами)* в организации Zitadel.

## Входные параметры модуля <a id="ug-inputs"/></a>

| Параметр (переменная) | Описание |
| - | -
| `zitadel_users` | Полный путь к YAML-файлу с описанием пользователей. Например, может быть определён так - `"${abspath(path.module)}/users.yml"`, что означает, взять из папки где запускается модуль файл `users.yml`. Формат описания пользователей см. в разделе ["Управление пользователями"](#ug-operations). |
| `template_file` | Имя файла [с шаблоном](./templates/) пользовательских ресурсов, которые будут создаваться. В каталоге [templates](./templates/) приведены несколько примеров для разных сценариев. При необходимости в этом же каталоге можно создавать другие шаблоны. |
| `template_data` | Строка в формате YAML со списком атрибутов и их значений, которые необходимо передать в шаблон, например? `"{yc_org_id: bpflg**********fwdei, yc_ba_id: dn2eq**********gv5gp}"`. Допускается задание пустого значения.

### Шаблоны пользовательских ресурсов <a id="user-template"/></a>

| Имя файла с шаблоном в каталоге templates | Описание шаблона |
| - | -
| `user.tpl` | Создаёт пользователя в Zitadel и добавляет его в [облачную организацию](https://yandex.cloud/ru/docs/organization/) Yandex Cloud. |
| `user-cloud-folder.tpl` | Дополнительно к шаблону `user.tpl` создаёт в Yandex Cloud для каждого пользователя [облако](https://yandex.cloud/ru/docs/resource-manager/concepts/resources-hierarchy#cloud) и [каталог](https://yandex.cloud/ru/docs/resource-manager/concepts/resources-hierarchy#folder), а также [выдаёт пользователю доступ](https://yandex.cloud/ru/docs/resource-manager/security/#resources) к этим объектам. |
| `user-cloud-folder-vpc-gw-rt.tpl` | Дополнительно к шаблону `user-cloud-folder.tpl` создаёт в пользовательском каталоге [сеть](https://yandex.cloud/ru/docs/vpc/concepts/network#network), [подсети](https://yandex.cloud/ru/docs/vpc/concepts/network#subnet), [NAT-шлюз](https://yandex.cloud/ru/docs/vpc/concepts/gateways) и [таблицу маршрутизации](https://yandex.cloud/ru/docs/vpc/concepts/static-routes) для всех подсетей, которая обеспечивает выход в Интернет для подключенных ресурсов. |
| `user-gitlab.tpl` | Дополнительно к шаблону `user.tpl` создаёт в Gitlab пользователя и репозиторий (project) для него.
| `user-gitlab-cloud-folder.tpl` | Дополнительно к шаблону `user-cloud-folder.tpl` создаёт в Gitlab пользователя и репозиторий (project) для него.


## Выходные параметры модуля <a id="ug-outputs"/></a>

Формально выходных параметров у модуля нет (он ничего не возвращает), однако в процессе своей работы он генерирует terraform код, который записывается в файл с определённым именем по определенному пути. Значения имени и пути определяются в коде модуля в переменной [users_out](./usersgen.tf). По умолчанию это значение равно `../../zitadel-config/users.tf`, но может быть изменено при необходимости.

## Управление пользователями <a id="ug-operations"/></a>

Под `управлением пользователями` понимаются следующие действия:
* добавление нового пользователя в Zitadel организацию.
* удаление существующего пользователя из Zitadel организации.
* изменение атрибутов у существующего в организации пользователя.

Управление пользователями осуществляется с помощью специального файла в формате YAML с описанием пользователей и их атрибутов. Каждая запись в этом файле описывает одного пользователя. В файле может быть одна или несколько записей.

Пример записи с описанием атрибутов для одного пользователя приведён ниже:

```yml
zuser1:
  fname: "First"
  lname: "Firstov"
  lang: "en"
  email: "first@myorg.org"
  pass: "Th3mVxPz5#mIDXlL7P"
```

где,

* `zuser1` - идентификатор пользователя
* `fname` - имя пользователя (First Name)
* `lname` - фамилия пользователя (Last Name)
* `lang` - язык интерфейса по-умолчанию для пользователя в Zitadel
* `pass` - пароль учетной записи пользователя

Примечание:
При аутентификация пользователь должен будет ввести свой идентификатор `zuser1` и пароль.

Файл с информацией о пользователях может быть первоначально создан как вручную, в соответствии с форматом описанным выше, так и автоматически сгенерирован скриптом [yamlgen.sh](./yamlgen.sh). Пример запуска скрипта из каталога `zitadel-config` может быть таким: 

```bash
../../usersgen/yamlgen.sh usr 5 > ./users.yml
```

что означает, что необходимо сгенерировать 5 учетных записей пользователей и сохранить их в файле `users.yml`. С вариантами запуска скрипта можно ознакомиться, запустив его без параметров.
